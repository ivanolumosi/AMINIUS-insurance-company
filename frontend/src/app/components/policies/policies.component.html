<!-- policies.component.html - Updated with Client Integration and Enhanced Dashboard -->
<div class="policies-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="page-title">
      <h1>
        <i class="fas fa-shield-alt"></i>
        Policy Management
      </h1>
      <p>Manage your insurance policies, catalog, templates, and reference data</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline" (click)="refreshData()">
        <i class="fas fa-sync-alt"></i>
        Refresh Data
      </button>
      <button class="btn btn-secondary" (click)="exportPolicies('csv')">
        <i class="fas fa-download"></i>
        Export CSV
      </button>
      <button class="btn btn-primary" (click)="openClientPolicyModal()">
        <i class="fas fa-plus"></i>
        New Policy
      </button>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'dashboard'"
      (click)="setActiveTab('dashboard')">
      <i class="fas fa-tachometer-alt"></i>
      Dashboard
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'policies'"
      (click)="setActiveTab('policies')">
      <i class="fas fa-file-contract"></i>
      Client Policies
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'catalog'"
      (click)="setActiveTab('catalog')">
      <i class="fas fa-book"></i>
      Policy Catalog
    </button>
    
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'reference'"
      (click)="setActiveTab('reference')">
      <i class="fas fa-cogs"></i>
      Reference Data
    </button>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-spinner">
    <i class="fas fa-spinner fa-spin"></i>
    Loading data...
  </div>

  <!-- Tab Content -->
  <div class="tab-content" *ngIf="!isLoading">
    
    <!-- Enhanced Dashboard Tab -->
    <div *ngIf="activeTab === 'dashboard'">
      <div class="section-header">
        <h2>
          <i class="fas fa-chart-pie"></i>
          Dashboard Overview
        </h2>
      </div>

      <div class="dashboard-grid" *ngIf="dashboardSummary">
        <div class="dashboard-card">
          <div class="card-icon blue">
            <i class="fas fa-file-contract"></i>
          </div>
          <div class="card-content">
            <h3>{{ dashboardSummary.totalPolicies }}</h3>
            <p>Total Policies</p>
          </div>
        </div>

        <div class="dashboard-card">
          <div class="card-icon green">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="card-content">
            <h3>{{ dashboardSummary.activePolicies }}</h3>
            <p>Active Policies</p>
          </div>
        </div>

        <div class="dashboard-card">
          <div class="card-icon orange">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="card-content">
            <h3>{{ dashboardSummary.expiringIn30Days }}</h3>
            <p>Maturing in 30 Days</p>
          </div>
        </div>

        <div class="dashboard-card">
          <div class="card-icon red">
            <i class="fas fa-clock"></i>
          </div>
          <div class="card-content">
            <h3>{{ dashboardSummary.expiringIn60Days }}</h3>
            <p>Maturing in 60 Days</p>
          </div>
        </div>

        <div class="dashboard-card">
          <div class="card-icon purple">
            <i class="fas fa-building"></i>
          </div>
          <div class="card-content">
            <h3>{{ dashboardSummary.totalCompanies }}</h3>
            <p>Insurance Companies</p>
          </div>
        </div>

        <div class="dashboard-card">
          <div class="card-icon teal">
            <i class="fas fa-users"></i>
          </div>
          <div class="card-content">
            <h3>{{ dashboardSummary.totalClients }}</h3>
            <p>Total Clients</p>
          </div>
        </div>
      </div>

      <!-- Enhanced Statistics Section -->
      <div class="statistics-section" *ngIf="policyStatistics">
        <div class="section-header">
          <h3>
            <i class="fas fa-chart-bar"></i>
            Policy Statistics
          </h3>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <h4>Policy Status Breakdown</h4>
            </div>
            <div class="stat-content">
              <div class="stat-row">
                <span>Active Policies:</span>
                <span class="stat-value success">{{ policyStatistics.activePolicies }}</span>
              </div>
              <div class="stat-row">
                <span>Matured Policies:</span>
                <span class="stat-value danger">{{ policyStatistics.expiredPolicies }}</span>
              </div>
              <div class="stat-row">
                <span>Cancelled Policies:</span>
                <span class="stat-value warning">{{ policyStatistics.cancelledPolicies }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Statistics -->
      <div class="detailed-statistics" *ngIf="policyStatisticsDetailed.length > 0">
        <div class="section-header">
          <h3>
            <i class="fas fa-chart-line"></i>
            Detailed Analytics
          </h3>
        </div>
        
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Name</th>
                <th>Total Policies</th>
                <th>Active Policies</th>
                <th>Active Rate</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let stat of policyStatisticsDetailed">
                <td>{{ stat.groupType }}</td>
                <td>{{ stat.groupName }}</td>
                <td>{{ stat.policyCount }}</td>
                <td>{{ stat.activeCount }}</td>
                <td>
                  <div class="progress-bar">
                    <div class="progress-fill" 
                         [style.width.%]="(stat.activeCount / stat.policyCount) * 100">
                    </div>
                    <span class="progress-text">
                      {{ ((stat.activeCount / stat.policyCount) * 100) | number:'1.0-1' }}%
                    </span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Client Policies Tab -->
    <div *ngIf="activeTab === 'policies'">
      <div class="section-header">
        <h2>
          <i class="fas fa-file-contract"></i>
          Client Policies
        </h2>
        <button class="btn btn-primary" (click)="openClientPolicyModal()">
          <i class="fas fa-plus"></i>
          Add New Policy
        </button>
      </div>

      <!-- Loading Clients Indicator -->
      <div *ngIf="isLoadingClients" class="loading-indicator">
        <i class="fas fa-spinner fa-spin"></i>
        Loading client information...
      </div>

      <!-- Search and Filter Section -->
      <div class="search-filter-section">
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input
            type="text"
            placeholder="Search policies by client name, policy name, company, or type..."
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange($event)"
          />
        </div>
        
        <div class="filters">
          <select [(ngModel)]="selectedStatus" (ngModelChange)="onFilterChange()">
            <option value="">All Statuses</option>
            <option *ngFor="let status of policyStatuses" [value]="status">{{ status }}</option>
          </select>
          
          <select [(ngModel)]="selectedCompany" (ngModelChange)="onFilterChange()">
            <option value="">All Companies</option>
            <option *ngFor="let company of companies" [value]="company.companyId">
              {{ company.companyName }}
            </option>
          </select>
          
          <select [(ngModel)]="selectedType" (ngModelChange)="onFilterChange()">
            <option value="">All Types</option>
            <option *ngFor="let type of policyTypes" [value]="type.typeId">
              {{ type.typeName }}
            </option>
          </select>
          
          <button class="btn btn-secondary" (click)="clearFilters()">
            <i class="fas fa-times"></i>
            Clear Filters
          </button>
        </div>
      </div>

      <!-- Bulk Actions -->
      <div class="actions-section" *ngIf="selectedPolicyIds.length > 0">
        <div class="bulk-actions">
          <span>{{ selectedPolicyIds.length }} policies selected</span>
          <button class="btn btn-sm btn-success" (click)="bulkActivatePolicies()">
            <i class="fas fa-check"></i>
            Activate
          </button>
          <button class="btn btn-sm btn-warning" (click)="bulkDeactivatePolicies()">
            <i class="fas fa-pause"></i>
            Deactivate
          </button>
        </div>
      </div>

      <!-- Policies Table -->
      <div class="table-container">
        <table class="data-table" *ngIf="filteredPolicies.length > 0">
          <thead>
            <tr>
              <th>
                <input 
                  type="checkbox" 
                  (change)="selectAllPolicies()"
                  [checked]="selectedPolicyIds.length === filteredPolicies.length"
                />
              </th>
              <th>Client Name</th>
              <th>Policy Name</th>
              <th>Company</th>
              <th>Type</th>
              <th>Status</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Days to Maturity</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr 
              *ngFor="let policy of filteredPolicies; trackBy: trackByPolicyId"
              [class.expired]="isPolicyMatured(policy)"
              [class.expiring-soon]="isPolicyMaturingSoon(policy)"
            >
              <td>
                <input 
                  type="checkbox" 
                  [checked]="selectedPolicyIds.includes(policy.policyId)"
                  (change)="togglePolicySelection(policy.policyId)"
                />
              </td>
              <td>
                <div class="client-info">
                  <strong>{{ policy.clientName || 'Loading...' }}</strong>
                  <div class="client-email" *ngIf="policy.clientEmail">
                    <small>{{ policy.clientEmail }}</small>
                  </div>
                </div>
              </td>
              <td>{{ policy.policyName }}</td>
              <td>{{ policy.companyName || 'N/A' }}</td>
              <td>{{ policy.typeName || 'N/A' }}</td>
              <td>
                <span class="status-badge" [ngClass]="getPolicyStatusColor(policy)">
                  {{ policy.status }}
                </span>
              </td>
              <td>{{ policy.startDate | date:'dd/MM/yyyy' }}</td>
              <td>{{ policy.endDate | date:'dd/MM/yyyy' }}</td>
              <td [ngClass]="{
                'text-danger': getDaysUntilMaturity(policy)! < 0,
                'text-warning': getDaysUntilMaturity(policy)! >= 0 && getDaysUntilMaturity(policy)! <= 30,
                'text-success': getDaysUntilMaturity(policy)! > 30
              }">
                <div class="maturity-info">
                  <div class="maturity-formatted">{{ getFormattedMaturityPeriod(policy) }}</div>
                  <div class="maturity-days">
                    <small>
                      {{ getDaysUntilMaturity(policy) }} days
                      <span *ngIf="getDaysUntilMaturity(policy)! < 0"> (Matured)</span>
                    </small>
                  </div>
                </div>
              </td>
              <td>
                <div class="policy-notes" *ngIf="policy.notes">
                  <span class="notes-preview" [title]="policy.notes">
                    {{ policy.notes.length > 30 ? (policy.notes | slice:0:30) + '...' : policy.notes }}
                  </span>
                </div>
                <div class="no-notes" *ngIf="!policy.notes">
                  <small class="text-muted">No notes</small>
                </div>
              </td>
              <td>
                <div class="action-buttons">
                 
                  <button 
                    class="btn btn-sm btn-info" 
                    (click)="loadPolicyHistory(policy.clientId)"
                    title="View Policy History"
                  >
                    <i class="fas fa-history"></i>
                  </button>
                  <button 
                    class="btn btn-sm btn-success" 
                    (click)="renewPolicy(policy)"
                    *ngIf="isPolicyMatured(policy) || isPolicyMaturingSoon(policy)"
                    title="Renew Policy"
                  >
                    <i class="fas fa-redo"></i>
                  </button>
                  <button 
                    class="btn btn-sm btn-danger" 
                    (click)="confirmDeletePolicy(policy)"
                    title="Delete Policy"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="no-data" *ngIf="filteredPolicies.length === 0">
          <i class="fas fa-file-contract"></i>
          <p>No policies found matching your criteria</p>
        </div>
      </div>
    </div>

    <!-- Policy Catalog Tab -->
    <div *ngIf="activeTab === 'catalog'">
      <div class="section-header">
        <h2>
          <i class="fas fa-book"></i>
          Policy Catalog
        </h2>
        <button class="btn btn-primary" (click)="openCatalogModal()">
          <i class="fas fa-plus"></i>
          Add to Catalog
        </button>
      </div>

      <!-- Catalog Table -->
      <div class="table-container">
        <table class="data-table" *ngIf="filteredCatalog.length > 0">
          <thead>
            <tr>
              <th>Policy Name</th>
              <th>Company</th>
              <th>Category</th>
              <th>Type</th>
              <th>Status</th>
              <th>Created Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of filteredCatalog; trackBy: trackByCatalogId">
              <td>
                <strong>{{ item.policyName }}</strong>
                <div class="policy-notes" *ngIf="item.notes">
                  {{ item.notes }}
                </div>
              </td>
              <td>{{ item.companyName || 'N/A' }}</td>
              <td>{{ item.categoryName || 'N/A' }}</td>
              <td>{{ item.typeName || 'N/A' }}</td>
              <td>
                <span class="status-badge" [ngClass]="item.isActive ? 'success' : 'secondary'">
                  {{ item.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td>{{ item.createdDate | date:'dd/MM/yyyy' }}</td>
              <td>
                <div class="action-buttons">
                  <button 
                    class="btn btn-sm btn-outline" 
                    (click)="openCatalogModal(item)"
                    title="Edit Catalog Item"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button 
                    class="btn btn-sm btn-danger" 
                    (click)="confirmDeleteCatalogItem(item)"
                    title="Delete Catalog Item"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="no-data" *ngIf="filteredCatalog.length === 0">
          <i class="fas fa-book"></i>
          <p>No catalog items found</p>
        </div>
      </div>
    </div>

  

    <!-- Reference Data Tab -->
    <div *ngIf="activeTab === 'reference'">
      <div class="section-header">
        <h2>
          <i class="fas fa-cogs"></i>
          Reference Data Management
        </h2>
      </div>

      <!-- Companies Section -->
      <div class="reference-section">
        <div class="section-header">
          <h3>Insurance Companies</h3>
          <button class="btn btn-primary" (click)="openCompanyModal()">
            <i class="fas fa-plus"></i>
            Add Company
          </button>
        </div>
        
        <div class="table-container">
          <table class="data-table" *ngIf="companies.length > 0">
            <thead>
              <tr>
                <th>Company Name</th>
                <th>Status</th>
                <th>Created Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let company of companies; trackBy: trackByCompanyId">
                <td>{{ company.companyName }}</td>
                <td>
                  <span class="status-badge" [ngClass]="company.isActive ? 'success' : 'secondary'">
                    {{ company.isActive ? 'Active' : 'Inactive' }}
                  </span>
                </td>
                <td>{{ company.createdDate | date:'dd/MM/yyyy' }}</td>
                <td>
                  <div class="action-buttons">
                    <button 
                      class="btn btn-sm btn-outline" 
                      (click)="openCompanyModal(company)"
                      title="Edit Company"
                    >
                      <i class="fas fa-edit"></i>
                    </button>
                    <button 
                      class="btn btn-sm btn-danger" 
                      (click)="confirmDeleteCompany(company)"
                      title="Delete Company"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Policy Types Section -->
      <div class="reference-section">
        <div class="section-header">
          <h3>Policy Types</h3>
          <button class="btn btn-primary" (click)="openTypeModal()">
            <i class="fas fa-plus"></i>
            Add Type
          </button>
        </div>
        
        <div class="table-container">
          <table class="data-table" *ngIf="policyTypes.length > 0">
            <thead>
              <tr>
                <th>Type Name</th>
                <th>Status</th>
                <th>Created Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let type of policyTypes; trackBy: trackByTypeId">
                <td>{{ type.typeName }}</td>
                <td>
                  <span class="status-badge" [ngClass]="type.isActive ? 'success' : 'secondary'">
                    {{ type.isActive ? 'Active' : 'Inactive' }}
                  </span>
                </td>
                <td>{{ type.createdDate | date:'dd/MM/yyyy' }}</td>
                <td>
                  <div class="action-buttons">
                    <button 
                      class="btn btn-sm btn-outline" 
                      (click)="openTypeModal(type)"
                      title="Edit Type"
                    >
                      <i class="fas fa-edit"></i>
                    </button>
                    <button 
                      class="btn btn-sm btn-danger" 
                      (click)="confirmDeleteType(type)"
                      title="Delete Type"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Categories Section -->
      <div class="reference-section">
        <div class="section-header">
          <h3>Policy Categories</h3>
          <button class="btn btn-primary" (click)="openCategoryModal()">
            <i class="fas fa-plus"></i>
            Add Category
          </button>
        </div>
        
        <div class="table-container">
          <table class="data-table" *ngIf="policyCategories.length > 0">
            <thead>
              <tr>
                <th>Category Name</th>
                <th>Description</th>
                <th>Status</th>
                <th>Created Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let category of policyCategories; trackBy: trackByCategoryId">
                <td>{{ category.categoryName }}</td>
                <td>{{ category.description || 'N/A' }}</td>
                <td>
                  <span class="status-badge" [ngClass]="category.isActive ? 'success' : 'secondary'">
                    {{ category.isActive ? 'Active' : 'Inactive' }}
                  </span>
                </td>
                <td>{{ category.createdDate | date:'dd/MM/yyyy' }}</td>
                <td>
                  <div class="action-buttons">
                    <button 
                      class="btn btn-sm btn-outline" 
                      (click)="openCategoryModal(category)"
                      title="Edit Category"
                    >
                      <i class="fas fa-edit"></i>
                    </button>
                    <button 
                      class="btn btn-sm btn-danger" 
                      (click)="confirmDeleteCategory(category)"
                      title="Delete Category"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Simplified Client Policy Modal -->
<!-- Updated Client Policy Modal with Policy Dropdown -->
<div class="modal-overlay" *ngIf="showClientPolicyModal" (click)="closeClientPolicyModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-file-contract"></i>
        {{ editingPolicy ? 'Edit Client Policy' : 'Add New Client Policy' }}
      </h3>
      <button class="modal-close" (click)="closeClientPolicyModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form [formGroup]="clientPolicyForm" (ngSubmit)="onSubmitClientPolicy()" class="modal-form">
      <div class="form-row">
        <div class="form-group">
          <label for="clientSearch">Client *</label>
          <div class="autocomplete-wrapper">
            <input
              id="clientSearch"
              type="text"
              placeholder="Search for client..."
              [(ngModel)]="clientSearchTerm"
              (ngModelChange)="onClientSearch($event)"
              [ngModelOptions]="{standalone: true}"
              [class.invalid]="isFieldInvalid(clientPolicyForm, 'clientId')"
            />
            <div class="autocomplete-results" *ngIf="clientSearchResults.length > 0">
              <div 
                *ngFor="let client of clientSearchResults" 
                class="autocomplete-item"
                (click)="selectClient(client)"
              >
                {{ client.FirstName }} {{ client.Surname }} - {{ client.Email }}
              </div>
            </div>
          </div>
          <div class="error-message" *ngIf="isFieldInvalid(clientPolicyForm, 'clientId')">
            {{ getFieldError(clientPolicyForm, 'clientId') }}
          </div>
        </div>

        <div class="form-group">
          <label for="policyId">Policy *</label>
          <select
            id="policyId"
            formControlName="policyId"
            [class.invalid]="isFieldInvalid(clientPolicyForm, 'policyId')"
          >
            <option value="">Select a policy...</option>
            <option 
              *ngFor="let policy of policyDropdownOptions" 
              [value]="policy.policyId"
            >
              {{ policy.policyName }}
            </option>
          </select>
          <div class="error-message" *ngIf="isFieldInvalid(clientPolicyForm, 'policyId')">
            {{ getFieldError(clientPolicyForm, 'policyId') }}
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" formControlName="status">
            <option *ngFor="let status of policyStatuses" [value]="status">
              {{ status }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="startDate">Start Date *</label>
          <input
            id="startDate"
            type="date"
            formControlName="startDate"
            [class.invalid]="isFieldInvalid(clientPolicyForm, 'startDate')"
          />
          <div class="error-message" *ngIf="isFieldInvalid(clientPolicyForm, 'startDate')">
            {{ getFieldError(clientPolicyForm, 'startDate') }}
          </div>
        </div>

        <div class="form-group">
          <label for="endDate">End Date *</label>
          <input
            id="endDate"
            type="date"
            formControlName="endDate"
            [class.invalid]="isFieldInvalid(clientPolicyForm, 'endDate')"
          />
          <div class="error-message" *ngIf="isFieldInvalid(clientPolicyForm, 'endDate')">
            {{ getFieldError(clientPolicyForm, 'endDate') }}
          </div>
        </div>
      </div>

      <!-- Date Range Validation Error -->
      <div class="form-group" *ngIf="clientPolicyForm.errors?.['dateRangeInvalid'] as error">
        <div class="error-message">
          {{ error.message }}
        </div>
      </div>

      <div class="form-group">
        <label for="notes">Notes</label>
        <textarea
          id="notes"
          rows="3"
          placeholder="Additional notes about this policy..."
          formControlName="notes"
        ></textarea>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeClientPolicyModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting">
          <i class="fas fa-spinner fa-spin" *ngIf="isSubmitting"></i>
          {{ isSubmitting ? 'Saving...' : (editingPolicy ? 'Update Policy' : 'Create Policy') }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Policy History Modal -->
<div class="modal-overlay" *ngIf="showHistoryModal" (click)="closeHistoryModal()">
  <div class="modal large-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-history"></i>
        Policy History
      </h3>
      <button class="modal-close" (click)="closeHistoryModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-content">
      <div *ngIf="policyHistory.length > 0; else noHistory">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Policy Name</th>
                <th>Company</th>
                <th>Type</th>
                <th>Status</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Duration (Days)</th>
                <th>State</th>
                <th>Created Date</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let history of policyHistory">
                <td>{{ history.policyName }}</td>
                <td>{{ history.companyName }}</td>
                <td>{{ history.typeName || 'N/A' }}</td>
                <td>
                  <span class="status-badge" [ngClass]="history.status === 'Active' ? 'success' : 
                                                       history.status === 'Expired' ? 'danger' : 'secondary'">
                    {{ history.status }}
                  </span>
                </td>
                <td>{{ history.startDate | date:'dd/MM/yyyy' }}</td>
                <td>{{ history.endDate | date:'dd/MM/yyyy' }}</td>
                <td>{{ history.policyDurationDays }}</td>
                <td>
                  <span class="state-badge" [ngClass]="history.policyState === 'Current' ? 'success' : 'secondary'">
                    {{ history.policyState }}
                  </span>
                </td>
                <td>{{ history.createdDate | date:'dd/MM/yyyy HH:mm' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <ng-template #noHistory>
        <div class="no-data">
          <i class="fas fa-history"></i>
          <p>No policy history found for this client</p>
        </div>
      </ng-template>
    </div>
  </div>
</div>

<!-- Policy Catalog Modal -->
<div class="modal-overlay" *ngIf="showCatalogModal" (click)="closeCatalogModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-book"></i>
        {{ editingCatalogItem ? 'Edit Catalog Item' : 'Add to Catalog' }}
      </h3>
      <button class="modal-close" (click)="closeCatalogModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form [formGroup]="catalogForm" (ngSubmit)="onSubmitCatalog()" class="modal-form">
      <div class="form-group">
        <label for="catalogPolicyName">Policy Name *</label>
        <div class="autocomplete-wrapper">
          <input
            id="catalogPolicyName"
            type="text"
            placeholder="Type or select policy name..."
            formControlName="policyName"
            (input)="onCatalogPolicyNameSearch($event)"
            [class.invalid]="isFieldInvalid(catalogForm, 'policyName')"
          />
          <div class="autocomplete-results" *ngIf="catalogPolicyNameSuggestions.length > 0">
            <div 
              *ngFor="let suggestion of catalogPolicyNameSuggestions" 
              class="autocomplete-item"
              (click)="selectCatalogPolicyName(suggestion)"
            >
              {{ suggestion.policyName }}
            </div>
          </div>
        </div>
        <div class="error-message" *ngIf="isFieldInvalid(catalogForm, 'policyName')">
          {{ getFieldError(catalogForm, 'policyName') }}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="catalogCompany">Insurance Company *</label>
          <select 
            id="catalogCompany" 
            formControlName="companyId"
            [class.invalid]="isFieldInvalid(catalogForm, 'companyId')"
          >
            <option value="">Select Company</option>
            <option *ngFor="let company of companies" [value]="company.companyId">
              {{ company.companyName }}
            </option>
          </select>
          <div class="error-message" *ngIf="isFieldInvalid(catalogForm, 'companyId')">
            {{ getFieldError(catalogForm, 'companyId') }}
          </div>
        </div>

        <div class="form-group">
          <label for="catalogType">Policy Type</label>
          <select id="catalogType" formControlName="typeId">
            <option value="">Select Type</option>
            <option *ngFor="let type of policyTypes" [value]="type.typeId">
              {{ type.typeName }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="catalogCategory">Policy Category</label>
        <select id="catalogCategory" formControlName="categoryId">
          <option value="">Select Category</option>
          <option *ngFor="let category of policyCategories" [value]="category.categoryId">
            {{ category.categoryName }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="catalogNotes">Notes</label>
        <textarea
          id="catalogNotes"
          rows="3"
          placeholder="Additional notes about this catalog item..."
          formControlName="notes"
        ></textarea>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeCatalogModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting">
          <i class="fas fa-spinner fa-spin" *ngIf="isSubmitting"></i>
          {{ isSubmitting ? 'Saving...' : (editingCatalogItem ? 'Update Item' : 'Add to Catalog') }}
        </button>
      </div>
    </form>
  </div>
</div>


<!-- Company Modal -->
<div class="modal-overlay" *ngIf="showCompanyModal" (click)="closeCompanyModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-building"></i>
        {{ editingCompany ? 'Edit Company' : 'Add Company' }}
      </h3>
      <button class="modal-close" (click)="closeCompanyModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form [formGroup]="companyForm" (ngSubmit)="onSubmitCompany()" class="modal-form">
      <div class="form-group">
        <label for="companyName">Company Name *</label>
        <input
          id="companyName"
          type="text"
          placeholder="Enter company name..."
          formControlName="companyName"
          [class.invalid]="isFieldInvalid(companyForm, 'companyName')"
        />
        <div class="error-message" *ngIf="isFieldInvalid(companyForm, 'companyName')">
          {{ getFieldError(companyForm, 'companyName') }}
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeCompanyModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting">
          <i class="fas fa-spinner fa-spin" *ngIf="isSubmitting"></i>
          {{ isSubmitting ? 'Saving...' : (editingCompany ? 'Update Company' : 'Add Company') }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Policy Type Modal -->
<div class="modal-overlay" *ngIf="showTypeModal" (click)="closeTypeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-tags"></i>
        {{ editingType ? 'Edit Policy Type' : 'Add Policy Type' }}
      </h3>
      <button class="modal-close" (click)="closeTypeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form [formGroup]="typeForm" (ngSubmit)="onSubmitType()" class="modal-form">
      <div class="form-group">
        <label for="typeName">Type Name *</label>
        <input
          id="typeName"
          type="text"
          placeholder="Enter policy type name..."
          formControlName="typeName"
          [class.invalid]="isFieldInvalid(typeForm, 'typeName')"
        />
        <div class="error-message" *ngIf="isFieldInvalid(typeForm, 'typeName')">
          {{ getFieldError(typeForm, 'typeName') }}
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeTypeModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting">
          <i class="fas fa-spinner fa-spin" *ngIf="isSubmitting"></i>
          {{ isSubmitting ? 'Saving...' : (editingType ? 'Update Type' : 'Add Type') }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Category Modal -->
<div class="modal-overlay" *ngIf="showCategoryModal" (click)="closeCategoryModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-folder"></i>
        {{ editingCategory ? 'Edit Category' : 'Add Category' }}
      </h3>
      <button class="modal-close" (click)="closeCategoryModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form [formGroup]="categoryForm" (ngSubmit)="onSubmitCategory()" class="modal-form">
      <div class="form-group">
        <label for="categoryName">Category Name *</label>
        <input
          id="categoryName"
          type="text"
          placeholder="Enter category name..."
          formControlName="categoryName"
          [class.invalid]="isFieldInvalid(categoryForm, 'categoryName')"
        />
        <div class="error-message" *ngIf="isFieldInvalid(categoryForm, 'categoryName')">
          {{ getFieldError(categoryForm, 'categoryName') }}
        </div>
      </div>

      <div class="form-group">
        <label for="categoryDescription">Description</label>
        <textarea
          id="categoryDescription"
          rows="3"
          placeholder="Enter category description..."
          formControlName="description"
        ></textarea>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeCategoryModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting">
          <i class="fas fa-spinner fa-spin" *ngIf="isSubmitting"></i>
          {{ isSubmitting ? 'Saving...' : (editingCategory ? 'Update Category' : 'Add Category') }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal-overlay" *ngIf="showConfirmationModal" (click)="closeConfirmationModal()">
  <div class="modal confirmation-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-exclamation-triangle text-warning"></i>
        {{ confirmationTitle }}
      </h3>
      <button class="modal-close" (click)="closeConfirmationModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-form">
      <p>{{ confirmationMessage }}</p>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeConfirmationModal()">
          Cancel
        </button>
        <button 
          type="button" 
          class="btn" 
          [ngClass]="confirmationActionClass"
          (click)="executeConfirmationAction()"
          [disabled]="isSubmitting"
        >
          <i class="fas fa-spinner fa-spin" *ngIf="isSubmitting"></i>
          {{ isSubmitting ? 'Processing...' : confirmationActionText }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container" *ngIf="toastMessage">
  <div class="toast" [ngClass]="toastType" [@slideIn]>
    <div class="toast-content">
      <i class="fas" [ngClass]="{
        'fa-check-circle': toastType === 'success',
        'fa-exclamation-triangle': toastType === 'warning',
        'fa-times-circle': toastType === 'error',
        'fa-info-circle': toastType === 'info'
      }"></i>
      <span>{{ toastMessage }}</span>
    </div>
    <button class="toast-close" (click)="hideToast()">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>